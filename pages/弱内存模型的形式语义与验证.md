- 补充： [[C++中的memory order]]
- # 背景
	- ## 弱内存模型
	  collapsed:: true
		- [[$blue]]==Weak/slack memory model==
		- 为了提高并发程序的执行效率而提出
		- 各个模型得弱化行为
			- TSO：每一个线程拥有一个储存缓冲区
			- PSO：每一个线程中得每一个内存位置拥有一个储存缓冲区
			- ARMv8弱内存模型：线程内前瞻执行，乱序执行和储存缓冲区
			- C++11弱内存模型：Promise，时间戳以及线程试图概念的引入
		- ### TSO 弱内存
			- Total Store order
			- 应用在x86和sparc中
			- store-load顺序(在某一内存地址上)被破坏，但是其余三种顺序仍然被保持，会维护两个读（写）操作之间的顺序
			- 这一放松打破了程序执行的顺序一致性，在并发程序执行时，会出现一些在顺序一致性下不会出现的结果
		- ### PSO 弱内存
			- Partial Store Order
			- 在TSO的基础上进一步放松对于内存操作之间顺序的限制
			- #### 内存屏障
				- **全屏障(full fence)**
					- 必须先把之前内存操作的结果迁移到共享内存中才能进行之后的内存操作
				- **store-store fence**
					- 两个写内存操作之间，必须前一个写迁移到功效内存中之后才能进行下一步内存操作
		- ### ARMv8弱内存模型
		  collapsed:: true
			- 早期满足非多副本原子性(non Multi-Copy Atomic, nMCA)
			- 由于验证和实现成本问题，修改为满足多副本原子性（MCA）
				- MCA：当一个线程对某一其他线程可见时，它要对其他所有线程可见。
			- **单线程中可能出现的打破SC的情况**
				- 当两条语句之间没有依赖之时就会放宽两条语句之间执行关系的约束
					- 具体的，假设有两条语句``x:=e;y:=f``
					- 若：
						- 变量x和y不相同
						- x没有出现在表达式f中
						- 表达式e中不包含变量y
						- 表达式e和f没有读取相同的全局变量
					- 则可以说两条语句之间没有依赖关系
				- 在**前瞻执行**时也会打破本有的执行顺序，分支执行在两种情况下会发生
					- 当分支指令是一条赋值语句``x:=e``时：
						- x是局部变量
						- e和分支判断语句h不会读取相同的全局变量
						- x不在h中自由出现
			- **并发执行**时，由于单线程中可能出现的乱序优化，可能会出现在SC和TSO模型下都不会出现的行为
		- ### C++11弱内存模型
		  collapsed:: true
			- 通常被定义成公理内存模型
			- 会将任意程序的可能执行结果形式化表达成内存访问事件图(Graphs of Memory Access Events)
				- 表达需要遵循一系列的公理
			- C++弱内存模型引入了多种内存顺序，本文关注两种内存顺序
				- **松弛内存顺序(Relaxed Memory Ordering)**
					- 最弱的内存顺序，不会给沦胥执行增加额外的约束条件，亦不涉及任何同步信息
				- **释放/获取内存顺序(Release/Acquire Memory Ordering)**
					- 为线程之间引入了轻量级的线程间同步关系
					- Acquire表示读之后的内存语句不能重排到acquire之前，可以用在load-store，load-load顺序中
					- Release表示写之前的内存语句不能重拍到release之后，可以用在store-load，store-store顺序中
			- #### Relaxed Access(松弛访问)
				- 对于某一个线程T来说，其内存视图是由T中所有出现过的内存位置的时间戳构成的
				- 用于确定内存访问上的正确语义
				- 一个例子，见论文正文15页
				- **松弛原子更新操作(relaxed atomic update)**是对同一内存位置的一对访问操作
					- 包括：读后改(Read-Modify-Write)，比较交换(Compare-and-swap)，取后加(Fetch-and-add)
					- 在promise语义中，需要做出的操作无非是将时间戳更换为时间段，本质上没有区别[[$red]]==(?)==
			- #### Release-acquire access
				- C++11通过内存屏障指令实现线程间的同步操作
	- ## 形式语义学
		- ### 操作语义
			- 完整描述程序执行过程中可以采取的每一个执行步骤
			- 聚焦于程序**如何(how)**运行
			- 补充： [[小步操作语义和大步操作语义]]
		-
		-