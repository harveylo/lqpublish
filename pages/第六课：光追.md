# 关于光线(Light Ray)的一些认知
	- 光线**沿直线传播**
		- 在现实中是不对的，应为光实际上是电磁波。但是认为其是沿直线传播所得到的模拟效果已经够好了
	- 光线之间**不会互相碰撞而产生干扰**
		- 也是不对的，但是效果已经够好
	- 光线从光源传递到眼中，使人眼成像
		- 但是在实际操作中往往是从摄像机处射出光线，看能够达到哪些物体，在这些物体上又会产生折射，反射等情况。这么做的正确性是应为光线路径的**可逆性**
- # 光线投射
	- ![image.png](../assets/image_1702996493319_0.png){:height 235, :width 327}
	- 光追的基本原理就是从眼睛(摄像机)处向场景中投射光线，并记录这些光线击中的第一个物体
	- 对击中的物体进行渲染过程，计算颜色，生成像素点信息
- # 递归式(Whitted-Style)光追
	- 由T.Whitted提出，是一种递归式(Recursive)的光追方法
	- ![image.png](../assets/image_1702997465650_0.png){:height 239, :width 402}
	- 光线可能会产生**折射**，**反射**等，这些情况会产生子光线
		- 子光线在能量上会有损耗，在最后合并计算颜色时每产生一次子光线，子光线的贡献都会被降低
		- 颜色是在击中物体表面时产生的，对每一个集中的点，都要计算其是否和光源有通路，如果有，纳入计算
	- ## 判定光面相交(Ray-Surface Intersection)
		- ### 光线的表示方式
			- 每一条光线由两个元素定义：源点和方向
				- ![image.png](../assets/image_1702997859349_0.png){:height 132, :width 158}
			- 光线可以被定义为一个函数，光线在$t$时刻传播所在的位置使用一个函数表示，即：
				- $\bold{r}(t)=\bold{o}+t\bold{d}\qquad 0\le t<\infin$
				- $\bold{d}$表示方向
		- ### 光线和球的相交求解
			- 一个球体可以表示为一堆点的集合，其中每一个点$\bold{p}$都满足：
				- $\bold{(p-c)}^2 = R^2$
				- 其中$\bold{c}$是球心，$R$是半径
			- 求解一条光线是否击中球体，就是求方程$(\bold{o}+t\bold{d-c})^2 = R^2$对$t$是否有解，根据二次方程求根公式，解析原方程得到：
				- $a=\bold{d\cdot d}$
				- $b = 2(\bold{o-c})\cdot \bold{d}$
				- $c = \bold{(o-c)\cdot(o-c)}-R^2$
			- 因此有：
				- $t = \frac{-b\pm\sqrt{b^2-4ac}}{2a}$
				- 但是我们只关注**正的实数**解，因为光线只沿一个方向传播
				- 如果两个解都是正的，那么去最小的那个，因为我们只关心光线第一次击中的点
		- ### 光线和隐式(implicit)表面的相交求解
			- 所有的隐式表面都可以表达为一个关于其表面任意一个点的方程：$f(\bold{p}) = 0$
			- 只需将光线表达式代入$\bold{p}$，对$t$求解方程$f(\bold{o}+t\bold{t})$即可
		- ### 光线和网格的相交求解
			- **[[$red]]==如何判断一个点是在物体内部还是外部？==**
				- 在该点发送一条射线，如果和物体有奇数个交点，那么就说明该点在物体内部
				- 前提是物体不能有洞，必须是封闭的
			- 光线和三角形是否相交可以转换为**光线是否和某个平面相交**的问题
				- 先判断光线是否和三角形所在的平面相交
				- 在判断相交的点是否在三角形内
			- **平面如何定义？**
				- ![image.png](../assets/image_1703175167099_0.png){:height 208, :width 247}
				- **一个方向**(法向量$\bold{N}$)和**一个点**(平面内任意一个点$\bold{p}'$)
					- 由于平面内任意一个点和法向量都是平行的，因此可以通过减去平面内某个点并和法向量求点积，如果为零则表示在平面内
				- $\bold{p-p'} \cdot \bold{N} = 0$，本质上可以写成：
					- $ax+by+cz+d = 0$
			- 求解时，仍然将光线带入，即可得到光线和平面的交点
				- $\bold{o}+t\bold{d-p'\cdot N}=0$
				- $t = \frac{\bold{(p'-o)\cdot N}}{\bold{d\cdot N}}$
				- 需要判断：$t\le t<\infin$
			- 一个更快的算法可以直接求得$t$和交点的三角形重心坐标表示，这就是**Moller Trumbore**算法
				- ![image.png](../assets/image_1703173785514_0.png){:height 319, :width 325}
				- 求解之后只需要判断$b_1,b_2,1-b_1-b_2$是否都是非负值即可判断点是否在三角形内部
			- 最简单的想法就是和物体的每一个三角形都求解一次
				- 十分缓慢，不可能
			- 注意到，光线和一个三角形的交点只有可能为0或1
				- 不考虑平行的情况
			- 需要使用**AABB**来提升速度
	- ## Bounding Volumes
		- 用一个形状把物体包起来，如果击中了这个形状再计算是否击中物体，否则直接不计算，一般常用的就是**包围盒(Bounding Box)**
		- 一个盒子再表达上就是三个**对面**形成的**交集**
		- 更常用的是**轴对齐包围盒(Axis-Aligned Bounding Box)**
			- 和轴对齐的面叫做**Slab**
			- **Slab**更好求解：
				- 例如，和x垂直的面的求解方式为：$t = \frac{\bold{p'}_x-\bold{o}_x}{\bold{d}_x}$
		- ### 求解光线是否击中AABB
			- 对每一组对面，分别求解两个$t$，即$t_\text{min}$和$t_\text{max}$
			- 最后计算出光线进入盒子的时间$t_\text{enter} = \text{max}\{t_\text{min}\}$，和离开盒子的时间$t_\text{exit} = \text{min}\{t_\text{max}\}$
			- 如果$t_\text{enter}<t_\text{exit}$，则击中，否则未击中
			- 如果$t_\text{exit}<0$，则盒子在光线后面，也不可能击中
			- 如果$t_\text{exit}\ge 0, t_\text{enter}<0$，则光线起点在盒子内部，一定击中
			- 所以最终得到光线击中盒子的条件：$t_\text{enter}<t_\text{exit} \wedge t_\text{exit}\ge 0$
	- ## 使用grid加速求交计算
		- ![image.png](../assets/image_1703253979417_0.png){:height 219, :width 358}
		- 将场景分割成若干cell，记录每个cell和物体表面的相交情况
		- 将光线和cell求交，对于不和物体表面相交的cell，直接略过；如果穿过了和物体表面有交点的cell，那么在去和物体求交
		- ### 分出多少个格子才合适？
			- 格子过少会导致和物体求交的次数上升，对于加速没有太大效果
			- 格子过多会导致和格子求交的次数变多，对于加速也会产生负面效果
			- 最合适的格子数量为：物体数量$\times C$
				- $C$是一个常数，在三维下的通常取值为27
		- [[$red]]==**如果场景内物体分布很不均匀**==，那么格子法的效果并不好
- # 空间划分
	- 用一些成熟的空间划分方式，可以很好的平衡不均匀物体分布带来的问题
	- ![image.png](../assets/image_1703254837516_0.png){:height 238, :width 558}
	- 八叉树(Oct-Tree)基本没有实际应用，常用的是KD-Tree，可以保持类似于二叉树的性质
	- ## KD-Tree
		- 先垂直划分，再在每一个划分出来的子节点中进行水平划分，循环往复
		- ![image.png](../assets/image_1703255244299_0.png){:height 284, :width 473}
		-