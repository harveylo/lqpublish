# 关于光线(Light Ray)的一些认知
	- 光线**沿直线传播**
		- 在现实中是不对的，应为光实际上是电磁波。但是认为其是沿直线传播所得到的模拟效果已经够好了
	- 光线之间**不会互相碰撞而产生干扰**
		- 也是不对的，但是效果已经够好
	- 光线从光源传递到眼中，使人眼成像
		- 但是在实际操作中往往是从摄像机处射出光线，看能够达到哪些物体，在这些物体上又会产生折射，反射等情况。这么做的正确性是应为光线路径的**可逆性**
- # 光线投射
	- ![image.png](../assets/image_1702996493319_0.png){:height 235, :width 327}
	- 光追的基本原理就是从眼睛(摄像机)处向场景中投射光线，并记录这些光线击中的第一个物体
	- 对击中的物体进行渲染过程，计算颜色，生成像素点信息
- # 递归式(Whitted-Style)光追
	- 由T.Whitted提出，是一种递归式(Recursive)的光追方法
	- ![image.png](../assets/image_1702997465650_0.png){:height 239, :width 402}
	- 光线可能会产生**折射**，**反射**等，这些情况会产生子光线
		- 子光线在能量上会有损耗，在最后合并计算颜色时每产生一次子光线，子光线的贡献都会被降低
		- 颜色是在击中物体表面时产生的，对每一个集中的点，都要计算其是否和光源有通路，如果有，纳入计算
	- ## 判定光面相交(Ray-Surface Intersection)
		- ### 光线的表示方式
			- 每一条光线由两个元素定义：源点和方向
				- ![image.png](../assets/image_1702997859349_0.png){:height 132, :width 158}
			- 光线可以被定义为一个函数，光线在$t$时刻传播所在的位置使用一个函数表示，即：
				- $\bold{r}(t)=\bold{o}+t\bold{d}\qquad 0\le t<\infin$
				- $\bold{d}$表示方向
		- ### 光线和球的相交求解
			- 一个球体可以表示为一堆点的集合，其中每一个点$\bold{p}$都满足：
				- $\bold{(p-c)}^2 = R^2$
				- 其中$\bold{c}$是球心，$R$是半径
			- 求解一条光线是否击中球体，就是求方程$(\bold{o}+t\bold{d-c})^2 = R^2$对$t$是否有解，根据二次方程求根公式，解析原方程得到：
				- $a=\bold{d\cdot d}$
				- $b = 2(\bold{o-c})\cdot \bold{d}$
				- $c = \bold{(o-c)\cdot(o-c)}-R^2$
			- 因此有：
				- $t = \frac{-b\pm\sqrt{b^2-4ac}}{2a}$
				- 但是我们只关注**正的实数**解，因为光线只沿一个方向传播
				- 如果两个解都是正的，那么去最小的那个，因为我们只关心光线第一次击中的点
		- ### 光线和隐式(implicit)表面的相交求解
			- 所有的隐式表面都可以表达为一个关于其表面任意一个点的方程：$f(\bold{p}) = 0$
			- 只需将光线表达式代入$\bold{p}$，对$t$求解方程$f(\bold{o}+t\bold{t})$即可
		- ### 光线和网格的相交求解
			- **[[$red]]==如何判断一个点是在物体内部还是外部？==**
				- 在该点发送一条射线，如果和物体有奇数个交点，那么就说明该点在物体内部
				- 前提是物体不能有洞，必须是封闭的
			- 光线和三角形是否相交可以转换为**光线是否和某个平面相交**的问题
				- 先判断光线是否和三角形所在的平面相交
				- 在判断相交的点是否在三角形内
			- **平面如何定义？**
				- ![image.png](../assets/image_1703175167099_0.png){:height 208, :width 247}
				- **一个方向**(法向量$\bold{N}$)和**一个点**(平面内任意一个点$\bold{p}'$)
					- 由于平面内任意一个点和法向量都是平行的，因此可以通过减去平面内某个点并和法向量求点积，如果为零则表示在平面内
				- $\bold{p-p'} \cdot \bold{N} = 0$，本质上可以写成：
					- $ax+by+cz+d = 0$
			- 求解时，仍然将光线带入，即可得到光线和平面的交点
				- $\bold{o}+t\bold{d-p'\cdot N}=0$
				- $t = \frac{\bold{(p'-o)\cdot N}}{\bold{d\cdot N}}$
				- 需要判断：$t\le t<\infin$
			- 一个更快的算法可以直接求得$t$和交点的三角形重心坐标表示，这就是**Moller Trumbore**算法
				- ![image.png](../assets/image_1703173785514_0.png){:height 319, :width 325}
				- 求解之后只需要判断$b_1,b_2,1-b_1-b_2$是否都是非负值即可判断点是否在三角形内部
			- 最简单的想法就是和物体的每一个三角形都求解一次
				- 十分缓慢，不可能
			- 注意到，光线和一个三角形的交点只有可能为0或1
				- 不考虑平行的情况
			- 需要使用**AABB**来提升速度
	- ## Bounding Volumes
		- 用一个形状把物体包起来，如果击中了这个形状再计算是否击中物体，否则直接不计算，一般常用的就是**包围盒(Bounding Box)**
		- 一个盒子再表达上就是三个**对面**形成的**交集**
		- 更常用的是**轴对齐包围盒(Axis-Aligned Bounding Box)**
			- 和轴对齐的面叫做**Slab**
			- **Slab**更好求解：
				- 例如，和x垂直的面的求解方式为：$t = \frac{\bold{p'}_x-\bold{o}_x}{\bold{d}_x}$
		- ### 求解光线是否击中AABB
			- 对每一组对面，分别求解两个$t$，即$t_\text{min}$和$t_\text{max}$
			- 最后计算出光线进入盒子的时间$t_\text{enter} = \text{max}\{t_\text{min}\}$，和离开盒子的时间$t_\text{exit} = \text{min}\{t_\text{max}\}$
			- 如果$t_\text{enter}<t_\text{exit}$，则击中，否则未击中
			- 如果$t_\text{exit}<0$，则盒子在光线后面，也不可能击中
			- 如果$t_\text{exit}\ge 0, t_\text{enter}<0$，则光线起点在盒子内部，一定击中
			- 所以最终得到光线击中盒子的条件：$t_\text{enter}<t_\text{exit} \wedge t_\text{exit}\ge 0$
	- ## 使用grid加速求交计算
		- ![image.png](../assets/image_1703253979417_0.png){:height 219, :width 358}
		- 将场景分割成若干cell，记录每个cell和物体表面的相交情况
		- 将光线和cell求交，对于不和物体表面相交的cell，直接略过；如果穿过了和物体表面有交点的cell，那么在去和物体求交
		- ### 分出多少个格子才合适？
			- 格子过少会导致和物体求交的次数上升，对于加速没有太大效果
			- 格子过多会导致和格子求交的次数变多，对于加速也会产生负面效果
			- 最合适的格子数量为：物体数量$\times C$
				- $C$是一个常数，在三维下的通常取值为27
		- [[$red]]==**如果场景内物体分布很不均匀**==，那么格子法的效果并不好
- # 用于光追的加速结构
	- ## 空间划分(Spatial Partition)
		- 空间上不会有重叠，一个物体可能会存在于多个节点中
		- 用一些成熟的空间划分方式，可以很好的平衡不均匀物体分布带来的问题
		- ![image.png](../assets/image_1703254837516_0.png){:height 238, :width 558}
		- 八叉树(Oct-Tree)基本没有实际应用，常用的是KD-Tree，可以保持类似于二叉树的性质
		- ### KD-Tree
			- 先垂直划分，再在每一个划分出来的子节点中进行轴对称的水平划分，循环往复
			- ![image.png](../assets/image_1703255244299_0.png){:height 284, :width 473}
			- 叶子节点存储对象列表
			- 当一束光线和某个盒子有交点时，判断其和两个子节点有没有交点，循环往复，直到叶子节点
				- 到叶子节点时，在和其中所有的物体求交点
			- 现代图形学KD-Tree用得并不多，因为非常难判断一个三角形是否和一个盒子有交集
	- ## 物体划分(Object Partition)
		- 物体划分可以避免在构建时耗费大量资源去计算包围盒和物体的交际
		- 将物体划分为**不重叠**的子集，但是不同的子集在空间上可能有重叠
		- 业界常用的物体划分就是**[[$red]]==Bounding Volume Hierarchy==**
		- ![image.png](../assets/image_1703590603980_0.png){:height 258, :width 542}
		- 一个物体只可能出现在一个格子里
		- [[$red]]==**缺点**==就是BVH的分割在空间上可能并不均匀
		- ### 如何分割？
			- 选择某一维进行分割
			- 提示1：总是选择更长的轴进行分割
				- 例如，一个盒子在x，y，z轴上的长度分别是2，10，1，那么就在y轴上分割
				- 可以让划分出的节点在空间的分布上稍微均匀一些
			- 提示2：选择**中点(median)**物体(以某个轴排序)，进行分割，使最后建出来的树尽量平衡
				- 使用快选可以快速得到中点物体
		- ### 递归构建的结束条件？
			- 当某个节点中所包含的物体小于一个阈值时即停止构建，称为叶子节点
		- ### 用于BVH的数据结构
			- **内部节点**
				- 包围盒
				- 子节点的指针
			- **叶节点**
				- 包围盒
				- 物体列表
		- ### 光线和BVH求交
			- ![image.png](../assets/image_1703593794662_0.png){:height 224, :width 471}
			- 类似于遍历二叉搜索树
- # 辐射度量学(Radiometry)
	- bling-phong模型中的光线强度就是一个数，但这个数到底是什么单位？
	- 辐射度量学的一大贡献就是精确定义光照强度的**单位**，并精确度量光照的**空间属性**
		- Radiant Flux
		- Intensity
		- Irradiance
		- Radiance
	- 在物理上以**准确的方式**定义光照，并进行准确的计算
	- ## 一些基本概念
		- **辐射能量(Radiant Energy)**
			- 向外的电磁辐射能量，**单位是焦耳(Joule, J)**
			- 常用**符号**：$Q$
		- **Radiant Flux(Power)**
			- **单位时间内**发散，反射，传播或收到的**能量**
			- $\Phi \equiv \frac{\text{d}Q}{\text{d}t} \text{[W=Watt] [lm = lumen]}$
			- 方括号括起来的为单位
		- **Flux**
			- 中文也称流量
			- **单位时间内**流经某个传感器的**光子(Photon)数量**
	- ## 一些光照的重要测量指标
		- ![image.png](../assets/image_1703596918904_0.png){:height 290, :width 510}
		- ### Radiant Intensity
		  collapsed:: true
			- 也称**光照强度(Luminous Intensity)**
			- 即由某个点光源在每**单位立体角(Solid Angle)**散发出的能量(Power)
			- $$I(\omega) \equiv \frac{\text{d}\Phi}{\text{d}\omega}\qquad [\frac{\text{W}}{\text{sr}}]\ [\frac{\text{lm}}{\text{sr}}=\text{cd}=\text{candela}]$$
			- **立体角**
			  collapsed:: true
				- **二维的角(Angle)**一般定义为此角度的圆弧和半径的比值
					- ![image.png](../assets/image_1703597751149_0.png){:height 205, :width 223}
					- $\theta = \frac{l}{r}$
					- 一个圆(Circle)有$2\pi$的**弧度(radian)**
				- **立体角(Solid angle)**定义为该角度在球面上所对的(subtended)面积和半径平方的比值
					- ![image.png](../assets/image_1703597938319_0.png){:height 215, :width 211}
					- $\Omega = \frac{A}{r^2}$
					- 一个球体(Sphere)有$4\pi$的**球面度(steradian)**
				- **单位立体角(Differential Solid Angles)**
					- 一般会使用球面坐标$\theta$，$\phi$来定义一个球体中唯一的方向
					- ![image.png](../assets/image_1703598447534_0.png){:height 296, :width 496}
					- ![image.png](../assets/image_1703598961009_0.png){:height 263, :width 465}
					- 可以直接使用立体角标识空间中的一个方向
			- **各项同性点源(Isotropic Point Source)**
				- ![image.png](../assets/image_1703599573686_0.png){:height 289, :width 433}
				- 能量均匀地分布在表面，那么其在某个方向的强度就是$I=\frac{\Phi}{4\pi}$
				- ![image.png](../assets/image_1703599713141_0.png){:height 285, :width 441}
		- ### Irradiance
			- 某个表面每单位区域接收到的能量(Power)
			- ![image.png](../assets/image_1703691148422_0.png){:height 201, :width 431}
			- 注意这里的区域必须是和光线垂直的区域，如果光线和区域不垂直，那么要进行换算
				- 回想之前学习的labert法则，其表面接收的能量和夹角余弦成比例就是这个原因
				- ![image.png](../assets/image_1703691736252_0.png){:height 249, :width 484}
			- 同理，之前提到的光线的**强度**会随着距离衰减，在这个视角下也不再正确
				- ![image.png](../assets/image_1703692125886_0.png){:height 252, :width 393}
				- 实际上衰减的并不是光线的**强度(intensity)**，而是单位面积内所能接收到的强度会随着距离衰减，即**Irradiance会随着距离衰减，和距离的平方成反比**
		- ### Radiance
			- 一条光线